===============================
Azure Batch Apps Python Client
===============================

The package is to enable Azure Batch Apps customers to interact with the
Management API using Python.

This client module is designed to work with the applications set up within an 
existing Batch Apps service.
You can upload your Application Image and Cloud Assembly via the `Batch Apps Portal <https://manage.batchapps.windows.net/>`_.
For more information on setting this up, `check out this article <http://azure.microsoft.com/en-us/documentation/articles/batch-dotnet-get-started/#tutorial2>`_.


License
========

This project is licensed under the MIT License.
For details see LICENSE.txt or visit `<http://opensource.org/licenses/MIT>`_

Installation
============

This package has been tested with Python 2.6, 2.7, 3.2, 3.3 and 3.4

>> pip install azure-batch-apps

Required packages:

* `Requests <http://docs.python-requests.org/en/latest/>`_

* `Keyring <https://bitbucket.org/kang/python-keyring-lib>`_

* `Requests-OAuthlib <http://requests-oauthlib.readthedocs.org/en/latest/>`_


Documentation
=============

The documentation is generated by Sphinx and can be found zipped up in the project 
root. It is also hosted online `here <http://dl.windowsazure.com/batchapps/pythondocs/>`_.


Release History
================

* 2014-11-xx	- 0.1.2 - Changed file upload format
* 2014-11-03	- 0.1.1 - Authentication bug fixes
* 2014-10-28	- 0.1.0	- Beta Release


Usage
============

Application Configuration
--------------------------

In order to interact with the applications set up in your services in your Batch Apps 
account, you will need to configure the python client.

To set up a new job type reference you can add it to the configuration file, 
along with any custom parameters you want associated with it.

When you instantiate a Configuration object for the first time, the configuration 
file will be created by default as::
	$HOME/BatchAppsData/batch_apps.ini

You can edit the file directly, or via the Configuration class::

	from batchapps import Configuration

	# This will be configured in your Azure AAD portal, or can be retrieved
	# when creating an unattended account in the Batch Apps portal.
	client_id = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'

	cfg = Configuration(log_level='debug', default=True)
	cfg.add_application('my_job_type', 'https://myservice.batchapps.core.windows.net', client_id)

	# Set this application as the current job type
	cfg.application('my_job_type')

	# Set the current job type as the default job type for future jobs
	cfg.set_default_application()

	# Add some custom parameters
	cfg.set('start_val') = 1
	cfg.set('end_val') = 100
	cfg.set('timeout') = 500

	# Save additional parameters to file
	cfg.save_config()

Authentication
---------------

The module authenticates with Azure Active Directory (an implementation of OAuth2).
The batchapps module provides a helper class to assist in retrieving an AAD token 
using Requests-OAuthlib. However if you have a preferred OAuth implementation, you 
can authenticate with this instead.

You can create a set of "Unattended Account" credentials in your `Batch Apps account <https://manage.batchapps.windows.net/>`_.
Once you have these credentials, you can authenticate the python client by adding them to the batch_apps.ini configuration 
file::

	[Authentication]
	service_principal = ClientId=abc;TenantId=abc
	service_principal_key = my_service_password

Then you can authenticate with these credentials::

	from batchapps import AzureOAuth

	creds = AzureOAuth.get_principal_token()


Or alternatively, if you use a different AAD implementation to retrieve a token::

	from batchapps import Credentials
	import my_oauth

	aad_token = my_oauth.get_token()
	creds = Credentials(aad_token)

Authentication via logging into a Web UI will be supported soon.


Job Management
---------------

Job management, including submission, monitoring, and accessing outputs is done 
through the JobManager class::

	from batchapps import AzureOAuth, JobManager

	creds = AzureOAuth.get_session()
	mgr = JobManager(creds)

	my_job = mgr.create_job("First Job")
	
	# Apply any custom parameters and source files here
	my_job.example_parameter = "test123"

	# Then submit the job
	new_job = my_job.submit()

	job_progress = mgr.get_job(url=new_job['link'])
	
	if job_progress.status == 'Complete':
		job_progress.get_output('c:\\my_download_dir')

	else:
		job_progress.cancel()


File Management
----------------

File management, including syncing job source files and dependencies to 
the cloud can be done using the FileManager class::

	from batchapps import AzureOAuth, FileManager

	creds = AzureOAuth.get_session()
	mgr = FileManager(creds)

	job_source = mgr.create_file('C:\\start_job.bat')
	file_collection = mgr.files_from_dir('c:\\my_job_assets')
	file_collection.add(job_source)

	file_collection.upload()

	# Check files previously uploaded matching a certain name
	mgr.find_files('start_job.bat')

	# Retrieve a list of all uploaded files
	mgr.list_files()


